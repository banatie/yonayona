  <!DOCTYPE html>
  <html>
    <head>
      {% load static %}
      <!--css-->
      <link type="text/css" rel="stylesheet" href="{% static 'communicate/css/materialize.min.css' %}" media="screen,projection"/>
      <link type="text/css" rel="stylesheet" href="{% static 'communicate/css/yonayona.css' %}"/>
      <!--js-->
      <!--images-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <link rel="apple-touch-icon" sizes="180x180" href="{% static 'communicate/images/favicon/apple-touch-icon.png' %}">
      <link rel="icon" type="image/png" sizes="32x32" href="{% static 'communicate/images/favicon/favicon-32x32.png' %}">
      <link rel="icon" type="image/png" sizes="16x16" href="{% static 'communicate/images/favicon/favicon-16x16.png' %}">
      <link rel="manifest" href="{% static 'communicate/images/favicon/site.webmanifest' %}">
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <body>
      <!--ボディ-->
      <!--indexページ-->
      {% if not user.is_authenticated %}
        <!--キービジュアル-->
        <div class="key-visual">
          <!--ナビゲーションヘッダ-->
          <div class="navbar-fixed">
            <nav class="transparent z-depth-0">
              <div class="nav-wrapper">
                <a href="{% url 'communicate:index' %}" class="brand-logo">yonayona</a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                  <li><a href="{% url 'communicate:signup' %}">Signup</a></li>
                  <li><a href="{% url 'communicate:about' %}">About</a></li>
                </ul>
              </div>
            </nav>
          </div>
          <!--ナビゲーションヘッダ-->
          <!--エラーメッセージ-->
          {% if error_message %}<h3 class="red-text center-align"><strong>{{ error_message }}</strong></h3>{% endif %}
          <!--エラーメッセージ-->
          <div class="container">
            <div id="hero-header">
              <h1>ようこそヨルの森へ</h1>
              <p>このふしぎな森では、夜中になると、心の中で誰かとつなげることができる。</p>
              <p>名前も顔もまったくわからない誰かと、よなよな話してみませんか。</p>
            </div>
            <div class="row">
              <form class="col s12" action="{% url 'communicate:login' %}" method="post">
                {% csrf_token %}
                <div class="row">
                  <div class="input-field col s8">
                    <i class="material-icons prefix icon-white">email</i>
                    <input name="email" id="email" type="email" class="validate" autofocus>
                    <label for ="email">Email</label>
                  </div>
                </div>
                <div class="row">
                  <div class="input-field col s8">
                    <i class="material-icons prefix icon-white">vpn_key</i>
                    <input name="password" id="password" type="password" class="validate">
                    <label for ="password">Password</label>
                  </div>
                </div>
                <div class="row">
                <div class="col offset-s7 s1">
                  <button class="btn waves-effect waves-light" type="submit" name="action">Login</button>
                </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!--indexページ-->
        <!--userページ-->
      {% else %}
        <!--キービジュアル-->
        <div class="key-visual">
          <!--ナビゲーションヘッダ-->
          <div class="navbar-fixed">
            <nav class="transparent z-depth-0">
              <div class="nav-wrapper">
                <a href="{% url 'communicate:index' %}" class="brand-logo">yonayona</a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                  <li><a href="{% url 'communicate:logout' %}">Logout</a></li>
                </ul>
              </div>
            </nav>
          </div>
          <!--ナビゲーションヘッダ-->
          <!--エラーメッセージ-->
          </p>
          {% if error_message %}<h3 class="red-text center-align"><strong>{{ error_message }}</strong></h3>{% endif %}
          <!--エラーメッセージ-->
          <!--サイドバー-->
          <div class="row">
            <div class="col s3" id="conversation-history">
              {% for conversation in history_conversations %}
                <div class="row">
                  <div class="col s8">
                    <a href="#" class="waves-effect waves-light grey darken-4 btn-large btn-conversation">
                      <i class="material-icons left">chat_bubble</i>
                      {{ conversation.date }}<br>
                      <span class="btn-sub-text right">{{ conversation.duration }}</span>
                    </a>
                  </div>
                  <div class="col offset-s1 s3">
                    <a href="{% url 'communicate:delete_conversation' conversation.id %}" class="waves-effect waves-light grey darken-4 btn-large btn-delete-conversation">
                      <i class="material-icons icon-white">delete</i>
                    </a>
                  </div>
                </div>
              {% endfor %}
            </div>
            <!--サイドバー-->
            <div class="col s9">
              <div class="container">
                <!--交信中-->
                {% if conversation_id %}
                  <div id="message-history">
                  </div>
                  <div id="message-sender col s12">
                    <div class="row">
                      <div class="input-field col s12">
                        <textarea id="message" class="white-text" autofocus></textarea>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col offset-s7 s3">
                        <!--モーダル-->
                        <!-- modal trigger -->
                        <a class="waves-effect waves-light btn-large modal-trigger" href="#modal-end-conversation">交信を終了</a>
                        <!-- end conversation modal -->
                        <div id="modal-end-conversation" class="modal">
                          <div class="modal-content black-text">
                            <h4>この出会いにさようならをしますか？</h4>
                          </div>
                          <div class="modal-footer">
                            <a class="modal-close waves-effect waves-green btn-flat">いいえ</a>
                            <a href="{% url 'communicate:end_conversation' conversation_id %}" class="modal-close waves-effect waves-green btn-flat">はい</a>
                          </div>
                        </div>
                        <!--モーダル-->
                      </div>
                      <div class="col s2">
                        <button id="btn-send-message" class="btn waves-effect waves-light btn-large" type="submit" name="action">交信</button>
                      </div>
                    </div>
                  </div>
                  <!--{{ value|json_script:"<id>" }}-->
                  {{ conversation_id|json_script:"conversation_id" }}
                  <script>
                    /* initialize modals */
                    document.addEventListener('DOMContentLoaded', function() {
                      const options = '';
                      var elems = document.querySelectorAll('.modal');
                      var instances = M.Modal.init(elems, options);
                    });

                    /* websocket */
                    /* create websocket connection */
                    const conversation_id = JSON.parse(document.getElementById('conversation_id').textContent);
                    const communicationSocket = new WebSocket(
                      'ws://'
                      + window.location.host
                      + '/ws/communicate/'
                      + conversation_id
                      + '/'
                    );

                    /* receive message */
                    communicationSocket.onmessage = function(e) {
                      const data = JSON.parse(e.data);

                      /* extract data */
                      const sender = data.username;
                      const message = data.message.replaceAll("\n", "<br>");

                      /* create the message dom */
                      var message_p = document.createElement('p');
                      message_p.classList.add('conversation');

                      /* align according to the sender */
                      if (sender == "{{ user.username }}") {
                        message_p.classList.add('right-align');  
                      } else {
                        message_p.classList.add('left-align');
                      }
                      /* add to message_history */
                      message_p.innerHTML = message;
                      var message_history = document.getElementById('message-history');
                      message_history.appendChild(message_p);

                      /* scroll down */
                      message_history.scrollTop = message_history.scrollHeight;
                    };

                    /* connection error */
                    communicationSocket.onclose = function(e) {
                      console.log('error');
                    };

                    /* click submit at enter */
                    document.querySelector('#message').onkeyup = function(e) {
                      if (e.ctrlKey && e.keyCode == 13) { // enter, or return
                        document.querySelector('#btn-send-message').click();
                      }
                    };

                    /* send message */
                    document.querySelector('#btn-send-message').onclick = function(e) {
                      /* username */
                      const username = "{{ user.username }}";
                      /* message */
                      const messageDom = document.querySelector('#message');
                      const message = messageDom.value;

                      /* send */
                      communicationSocket.send(JSON.stringify({
                        'username': username,
                        'message' : message
                      }));
                      /* clear input */
                      messageDom.value = '';
                    };
                  </script>
                  <!--websocket-->
                </div>
              <!--交信中-->
              {% else %}
                <!--交信外-->
                <div class="row" id="user-top">
                  <div class="col offset-s4 s4">
                    <form action="{% url 'communicate:start_conversation' %}" method="post">
                      {% csrf_token %}
                      <button id="send" class="btn waves-effect waves-light btn-large" type="submit" name="action">交信を開始</button>
                    </form>
                  </div>
                </div>
                <h5>
                よなよな起きている人に、悪いひとはいません<br>
                ヨルの森で、素敵ではかない出会いをしてみませんか
                </h5>
                <!--交信外-->
              {% endif %}
            </div>
          </div>
        </div>
      <!--userページ-->
      {% endif %}
      <!--ボディ-->
      <!--JavaScript at end of body for optimized loading-->
      <script type="text/javascript" src="{% static 'communicate/js/materialize.min.js' %}"></script>
    </body>
  </html>
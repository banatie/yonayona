  <!DOCTYPE html>
  <html>
    <head>
      {% load static %}
      <!--css-->
      <link type="text/css" rel="stylesheet" href="{% static 'communicate/css/materialize.min.css' %}" media="screen,projection"/>
      <link type="text/css" rel="stylesheet" href="{% static 'communicate/css/yonayona.css' %}"/>
      <!--js-->
      <!--images-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <link rel="apple-touch-icon" sizes="180x180" href="{% static 'communicate/images/favicon/apple-touch-icon.png' %}">
      <link rel="icon" type="image/png" sizes="32x32" href="{% static 'communicate/images/favicon/favicon-32x32.png' %}">
      <link rel="icon" type="image/png" sizes="16x16" href="{% static 'communicate/images/favicon/favicon-16x16.png' %}">
      <link rel="manifest" href="{% static 'communicate/images/favicon/site.webmanifest' %}">
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <body>
      <!--キービジュアル-->
      <div class="key-visual">
        <!--ボディ-->
        <!--indexページ-->
        {% if not user.is_authenticated %}
          <!--ナビゲーションヘッダ-->
          <div class="navbar-fixed">
            <nav class="transparent z-depth-0">
              <div class="nav-wrapper">
                <a href="{% url 'communicate:index' %}" class="brand-logo">yonayona</a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                  <li><a href="{% url 'communicate:signup' %}">Signup</a></li>
                  <li><a href="{% url 'communicate:about' %}">About</a></li>
                </ul>
              </div>
            </nav>
          </div>
          <!--ナビゲーションヘッダ-->
          <!--エラーメッセージ-->
          {% if error_message %}<h3 class="red-text center-align"><strong>{{ error_message }}</strong></h3>{% endif %}
          <!--エラーメッセージ-->
          <div class="container">
            <div id="hero-header">
              <h3>ヨナヨナの森</h3>
              <p>深夜0時を過ぎると、この森は不思議な空間になります。<br>
              こころの中で強く念じると、世界の誰か<strong>1人</strong>とだけ更新することができます。<br>
              その日どんな人と更新するのかを選ぶことはできません。<br>
              夜が開けると、2度とその人と再開することはできません。<br>
              その夜だけのめぐり逢わせを、ヨナヨナお楽しみください。<br>
              </p>
            </div>
            <div class="row">
              <form class="col s12" action="{% url 'communicate:login' %}" method="post">
                {% csrf_token %}
                <div class="row">
                  <div class="input-field col s8">
                    <i class="material-icons prefix icon-white">email</i>
                    <input name="email" id="email" type="email" class="validate" autofocus>
                    <label for ="email">Email</label>
                  </div>
                </div>
                <div class="row">
                  <div class="input-field col s8">
                    <i class="material-icons prefix icon-white">vpn_key</i>
                    <input name="password" id="password" type="password" class="validate">
                    <label for ="password">Password</label>
                  </div>
                </div>
                <div class="row">
                <div class="col offset-s7 s1">
                  <button class="btn waves-effect waves-light" type="submit" name="action">Login</button>
                </div>
                </div>
              </form>
            </div>
          </div>
          <!--indexページ-->
          <!--userページ-->
        {% else %}
          <!--ナビゲーションヘッダ-->
          <div class="navbar-fixed">
            <nav class="transparent z-depth-0">
              <div class="nav-wrapper">
                <a href="{% url 'communicate:index' %}" class="brand-logo">yonayona</a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                  <li><a href="{% url 'communicate:logout' %}">Logout</a></li>
                </ul>
              </div>
            </nav>
          </div>
          <!--ナビゲーションヘッダ-->
          <!--エラーメッセージ-->
          </p>
          {% if error_message %}<h3 class="red-text center-align"><strong>{{ error_message }}</strong></h3>{% endif %}
          <!--エラーメッセージ-->
          <!--サイドバー-->
          <div class="row">
            <div class="col s3" id="conversation-history">
              {% for conversation in history_conversations %}
                <div class="row">
                  <div class="col s8">
                    <a href="{% url 'communicate:view_conversation' conversation.id %}" class="waves-effect waves-light grey darken-4 btn-large btn-conversation">
                      <i class="material-icons left">chat_bubble</i>
                      {{ conversation.date }}<br>
                      <span class="btn-sub-text right">{{ conversation.duration }}</span>
                    </a>
                  </div>
                  <div class="col offset-s1 s3">
                    <!--モーダル-->
                    <!-- modal trigger -->
                    <a href="#modal-delete-conversation" class="waves-effect waves-light grey darken-4 btn-large btn-delete-conversation modal-trigger">
                      <i class="material-icons icon-white">delete</i>
                    </a>
                    <!-- delete conversation modal -->
                    <div id="modal-delete-conversation" class="modal left-align">
                      <div class="modal-content black-text">
                        <h4>この会話を削除しますか</h4>
                      </div>
                      <div class="modal-footer">
                        <a href="{% url 'communicate:delete_conversation' conversation.id %}" class="modal-close waves-effect waves-green btn-flat">はい</a>
                        <a class="modal-close waves-effect waves-green btn-flat">いいえ</a>
                      </div>
                    </div>
                    <!--モーダル-->
                  </div>
                </div>
              {% endfor %}
            </div>
            <!--サイドバー-->
            <div class="col s9">
              <div class="container">
                <!--交信中-->
                {% if active_conversation_id %}
                  <div class="row">
                    <div class="col s12" id="active-message-history">
                      {% for message in messages_to_communicate %}
                        {% if message.user_from.username == user.username %}
                          <p class="conversation right-align">{{ message.text|linebreaksbr }}</p>
                        {% else %}
                          <p class="conversation left-align">{{ message.text|linebreaksbr }}</p>
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                  <div class="row">
                    <div class="input-field col s12" id="message-sender">
                      <textarea id="message" class="white-text" autofocus></textarea>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col offset-s7 s3">
                      <!--モーダル-->
                      <!-- modal trigger -->
                      <a class="waves-effect waves-light btn-large modal-trigger" href="#modal-end-conversation">交信を終了</a>
                      <!-- end conversation modal -->
                      <div id="modal-end-conversation" class="modal">
                        <div class="modal-content black-text">
                          <h4>この出会いにさようならをしますか</h4>
                        </div>
                        <div class="modal-footer">
                          <a class="modal-close waves-effect waves-green btn-flat">いいえ</a>
                          <a href="{% url 'communicate:end_conversation' active_conversation_id %}" class="modal-close waves-effect waves-green btn-flat">はい</a>
                        </div>
                      </div>
                        <!--モーダル-->
                    </div>
                    <div class="col s2">
                      <button id="btn-send-message" class="btn waves-effect waves-light btn-large" type="submit" name="action">交信</button>
                    </div>
                  </div>
                  <!--{{ value|json_script:"<id>" }}-->
                  {{ active_conversation_id|json_script:"active_conversation_id" }}
                  <script>
                    /* scroll down at refresh */
                    var messageHistory = document.getElementById('active-message-history');
                    messageHistory.scrollTop = messageHistory.scrollHeight;

                    /* audio */
                    //var typewriterType = new Audio("{% static 'communicate/audio/typewriter_type_short.mp3' %}");

                    /* websocket */
                    /* create websocket connection */
                    const activeConversationId = JSON.parse(document.getElementById('active_conversation_id').textContent);
                    const communicationSocket = new WebSocket(
                      'ws://'
                      + window.location.host
                      + '/ws/communicate/'
                      + activeConversationId
                      + '/'
                    );

                    /* receive message */
                    communicationSocket.onmessage = function(e) {
                      const data = JSON.parse(e.data);

                      /* extract data */
                      const sender = data.username;
                      const message = data.message.replaceAll("\n", "<br>");
                      //var message = "{{ data.message|linebreaksbr }}";

                      /* create the message dom */
                      var messageP = document.createElement('p');
                      messageP.classList.add('conversation');

                      /* align according to the sender */
                      if (sender == "{{ user.username }}") {
                        messageP.classList.add('right-align');
                      } else {
                        messageP.classList.add('left-align');
                      }

                      var messageHistory = document.getElementById('active-message-history');
                      messageHistory.appendChild(messageP);

                      /* add to messageHistory with typewriter effect */
                      var i = 0;
                      const speed = 65; // milliseconds
                      function typeWriter() {
                        if (i < message.length) {
                          if (message.slice(i, i+4) == '<br>') {
                            messageP.innerHTML += '<br>';
                            i += 4;
                          } else {
                            //typewriterType.play();
                            messageP.innerHTML += message.charAt(i);
                            messageHistory.scrollTop = messageHistory.scrollHeight;
                            i++;
                          }
                          setTimeout(typeWriter, speed);
                        }
                      }
                      typeWriter();

                      /* scroll down */
                      messageHistory.scrollTop = messageHistory.scrollHeight;
                    };

                    /* connection error */
                    communicationSocket.onclose = function(e) {
                      console.log('error');
                    };

                    /* click submit at enter */
                    document.querySelector('#message').onkeyup = function(e) {
                      if (e.ctrlKey && e.keyCode == 13) { // enter, or return
                        document.querySelector('#btn-send-message').click();
                      }
                    };

                    /* send message */
                    document.querySelector('#btn-send-message').onclick = function(e) {
                      /* username */
                      const username = "{{ user.username }}";
                      /* message */
                      const messageDom = document.querySelector('#message');
                      const message = messageDom.value;

                      /* send */
                      communicationSocket.send(JSON.stringify({
                        'username': username,
                        'message' : message
                      }));
                      /* clear input */
                      messageDom.value = '';
                    };
                  </script>
                  <!--websocket-->
                <!--交信中-->
                {% elif messages_to_view %}
                  <div class="row">
                    <div class="col s12" id="inactive-message-history">
                      {% for message in messages_to_view %}
                        {% if message.user_from.username == user.username %}
                          <p class="conversation right-align">{{ message.text|linebreaksbr }}</p>
                        {% else %}
                          <p class="conversation left-align">{{ message.text|linebreaksbr }}</p>
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                  <div class="row">
                    <div class="col offset-s9 s3">
                      <a href="{% url 'communicate:index' %}" class="waves-effect waves-light btn-large">交信に戻る</a>
                    </div>
                  </div>
                  <script>
                    var messageHistory = document.getElementById('inactive-message-history');
                    messageHistory.scrollTop = messageHistory.scrollHeight;
                  </script>
                {% else %}
                  <!--交信外-->
                  <div class="center-align">
                    <div class="row" id="user-top">
                      <div class="col offset-s4 s4">
                        <form action="{% url 'communicate:start_conversation' %}" method="post">
                          {% csrf_token %}
                          <button id="send" class="btn waves-effect waves-light btn-large" type="submit" name="action">交信を開始</button>
                        </form>
                      </div>
                    </div>
                    <h3>ヨナヨナの森</h3>
                    <p>深夜0時を過ぎると、この森は不思議な空間になります。<br>
                    こころの中で強く念じると、世界の誰か<strong>1人</strong>とだけ更新することができます。<br>
                    その日どんな人と更新するのかを選ぶことはできません。<br>
                    夜が開けると、2度とその人と再開することはできません。<br>
                    その夜だけのめぐり逢わせを、ヨナヨナお楽しみください。<br>
                    </p>
                  </div>
                  <!--交信外-->
                {% endif %}
              </div>
            </div>
          </div>
        <!--userページ-->
        {% endif %}
        <footer class="page-footer transparent z-depth-0">
          <div class="footer-copyright">
            © 2021 Banatie All Rights Reserved.
          </div>
        </footer>
      </div>
      <!--ボディ-->
      <!--JavaScript at end of body for optimized loading-->
      <script>
        /* initialize modals */
        document.addEventListener('DOMContentLoaded', function() {
          var modals = document.querySelectorAll('.modal');
          M.Modal.init(modals, '');
        });

        /* background music */
        var bgm = new Audio("{% static 'communicate/audio/quite_time.mp3' %}");
        bgm.loop = true;
        bgm.play();
      </script>
      <script type="text/javascript" src="{% static 'communicate/js/materialize.min.js' %}"></script>
    </body>
  </html>